/*
 * Function_Generator.c
 *
 *  Created on: Oct 19, 2019
 *      Author: User01
 *  Description: Generate 4 waveforms at 5 frequencies, settings are changed by keypad
 */


#include "msp.h"
#include "ISR.h"
#include "LED_blinky.h"
#include "set_DCO.h"
#include "ISR.h"
#include "CPE329.h"
#include <math.h>

enum waveform{
    heart,
    square_wave,
    sine_wave,
    sawtooth_wave,
};

uint8_t _waveform, _DutyCycle;
uint16_t sine_bit[314], _CCR_bit, _freq;
uint16_t heart_bit[] = {2488.836071 ,2596.47242 ,2697.897288 ,2650.131385 ,2459.886212 ,2298.324474 ,2338.013298 ,2568.36587 ,2781.684581 ,2761.344328 ,2499.072513 ,2224.296694 ,2199.821672 ,2467.336831 ,2789.396019 ,2858.819693 ,2590.01712 ,2215.415836 ,2082.1845 ,2327.371969 ,2736.054874 ,2927.51667 ,2708.221628 ,2263.746529 ,2000.206862 ,2170.287827 ,2628.768992 ,2953.68286 ,2832.810109 ,2361.064641 ,1965.629106 ,2016.440027 ,2477.545957 ,2927.956906 ,2943.94259 ,2495.351722 ,1985.131327 ,1884.900371 ,2296.340044 ,2846.50265 ,3023.604723 ,2650.883286 ,2059.560739 ,1792.241008 ,2102.322966 ,2711.473012 ,3056.993866 ,2809.369968 ,2183.763179 ,1751.122341 ,1914.459278 ,2530.886875 ,3033.863586 ,2951.578843 ,2346.993028 ,1769.082547 ,1751.755831 ,2317.941217 ,2949.549817 ,3059.154407 ,2533.864126 ,1847.733892 ,1631.423814 ,2089.817556 ,2805.523044 ,3116.42294 ,2725.759396 ,1982.482098 ,1567.155214 ,1866.087573 ,2609.384856 ,3111.990596 ,2902.573593 ,2162.818124 ,1567.690567 ,1666.861518 ,2374.29048 ,3039.973097 ,3044.630786 ,2373.170825 ,1635.822959 ,1510.848938 ,2117.837576 ,2900.731764 ,3134.599813 ,2594.25294 ,1767.941375 ,1413.511626 ,1860.514216 ,2701.037075 ,3159.22881 ,2804.78444 ,1954.166212 ,1385.482465 ,1623.842255 ,2453.634109 ,3110.734442 ,2983.439999 ,2179.074865 ,1431.401439 ,1428.382808 ,2176.239684 ,2987.711206 ,3110.844213 ,2422.96039 ,1549.283535 ,1291.785743 ,1890.054085 ,2795.468694 ,3171.431328 ,2663.51629 ,1730.485836 ,1227.063549 ,1617.916087 ,2545.755984 ,3154.996127 ,2877.79982 ,1960.287038 ,1241.251846 ,1382.264387 ,2255.887956 ,3057.788565 ,3044.298768 ,2219.03679 ,1334.585626 ,1203.088459 ,1947.343042 ,2883.044381 ,3144.914899 ,2483.779785 ,1500.275065 ,1096.05518 ,1643.950974 ,2640.893785 ,3166.682336 ,2730.215144 ,1724.911375 ,1070.984083 ,1369.82779 ,2347.645918 ,3103.06083 ,2934.819418 ,1989.47656 ,1130.814759 ,1147.240245 ,2024.503199 ,2954.680162 ,3076.944576 ,2270.876017 ,1271.167373 ,994.5904619 ,1695.811702 ,2729.459819 ,3140.702164 ,2543.864893 ,1480.545119 ,924.7032041 ,1386.996717 ,2442.083228 ,3116.461671 ,2783.202089 ,1741.170465 ,943.5732281 ,1122.362681 ,2112.86334 ,3001.823555 ,2965.843446 ,2030.390197 ,1049.690903 ,922.9508422 ,1766.091167 ,2801.97261 ,3072.979842 ,2322.532719 ,1234.014022 ,804.6450957 ,1428.005906 ,2529.371378 ,3091.737512 ,2591.059459 ,1480.596969 ,776.6963732 ,1124.560356 ,2202.811434 ,3016.385772 ,2810.824292 ,1767.830091 ,840.8005975 ,879.1752239 ,1845.89728 ,2848.939209 ,2960.243287 ,2070.187485 ,990.8174331 ,710.6786685 ,1485.088328 ,2599.093567 ,3023.182777 ,2360.33529 ,1213.161098 ,631.6126828 ,1147.4643 ,2283.4924 ,2990.396466 ,2611.419042 ,1487.83518 ,647.0568192 ,858.404683 ,1924.379844 ,2860.379834 ,2799.330682 ,1790.025832 ,754.0747961 ,639.3811959 ,1547.748312 ,2639.559126 ,2904.754819 ,2092.116817 ,941.834341 ,506.0522891 ,1181.133248 ,2341.787993 ,2914.80958 ,2365.949506 ,1192.38941 ,466.8206859 ,851.2357637 ,1987.181431 ,2824.127287 ,2585.123591 ,1482.050537 ,521.9693953 ,581.5630925 ,1600.366743 ,2635.258974 ,2727.118852 ,1783.205123 ,663.427772 ,390.2600678 ,1208.263457 ,2358.322776 ,2775.006578 ,2066.378676 ,875.1280251 ,288.2455291 ,837.4936842 ,2009.819 ,2718.478046 ,2302.213768 ,1133.747937 ,277.6019897 ,511.3833467 ,1610.389066 ,2553.699979 ,2462.696776 ,1409.145318 ,349.5478592 ,245.757703 ,1180.317329 ,2280.137715 ,2518.961131 ,1660.835392 ,476.9100942 ,35.89651524 ,720.1876119 ,1870.96613 ,2353.787491 ,1870.966131 ,720.1876119 ,35.89651524 ,476.9100942 ,1660.835392 ,2518.961131 ,2280.137715 ,1180.317329 ,245.757703 ,349.5478592 ,1409.145318 ,2462.696776 ,2553.699979 ,1610.389066 ,511.3833467 ,277.6019897 ,1133.747937 ,2302.213767 ,2718.478046 ,2009.819 ,837.4936842 ,288.2455291 ,875.1280251 ,2066.378676 ,2775.006578 ,2358.322776 ,1208.263457 ,390.2600678 ,663.427772 ,1783.205123 ,2727.118852 ,2635.258974 ,1600.366743 ,581.5630925 ,521.9693953 ,1482.050537 ,2585.123591 ,2824.127287 ,1987.181431 ,851.2357637 ,466.8206859 ,1192.38941 ,2365.949506 ,2914.80958 ,2341.787993 ,1181.133248 ,506.0522891 ,941.834341 ,2092.116817 ,2904.754819 ,2639.559126 ,1547.748312 ,639.3811959 ,754.0747961 ,1790.025832 ,2799.330682 ,2860.379834 ,1924.379844 ,858.404683 ,647.0568192 ,1487.83518 ,2611.419042 ,2990.396466 ,2283.4924 ,1147.4643 ,631.6126828 ,1213.161098 ,2360.33529 ,3023.182777 ,2599.093567 ,1485.088328 ,710.6786685 ,990.8174331 ,2070.187485 ,2960.243287 ,2848.939209 ,1845.89728 ,879.1752239 ,840.8005975 ,1767.830091 ,2810.824292 ,3016.385772 ,2202.811434 ,1124.560356 ,776.6963732 ,1480.596969 ,2591.059459 ,3091.737512 ,2529.371378 ,1428.005906 ,804.6450957 ,1234.014022 ,2322.532719 ,3072.979842 ,2801.97261 ,1766.091167 ,922.9508422 ,1049.690903 ,2030.390197 ,2965.843446 ,3001.823555 ,2112.86334 ,1122.362681 ,943.5732281 ,1741.170465 ,2783.202089 ,3116.461671 ,2442.083228 ,1386.996717 ,924.7032041 ,1480.545119 ,2543.864893 ,3140.702164 ,2729.459819 ,1695.811702 ,994.5904619 ,1271.167373 ,2270.876017 ,3076.944576 ,2954.680162 ,2024.503199 ,1147.240245 ,1130.814759 ,1989.47656 ,2934.819418 ,3103.06083 ,2347.645918 ,1369.82779 ,1070.984083 ,1724.911375 ,2730.215144 ,3166.682336 ,2640.893785 ,1643.950974 ,1096.05518 ,1500.275065 ,2483.779785 ,3144.914899 ,2883.044381 ,1947.343042 ,1203.088459 ,1334.585626 ,2219.03679 ,3044.298768 ,3057.788565 ,2255.887956 ,1382.264387 ,1241.251846 ,1960.287038 ,2877.79982 ,3154.996127 ,2545.755984 ,1617.916087 ,1227.063549 ,1730.485836 ,2663.51629 ,3171.431328 ,2795.468694 ,1890.054085 ,1291.785743 ,1549.283535 ,2422.96039 ,3110.844213 ,2987.711206 ,2176.239684 ,1428.382808 ,1431.401439 ,2179.074865 ,2983.439999 ,3110.734442 ,2453.634109 ,1623.842255 ,1385.482465 ,1954.166212 ,2804.78444 ,3159.22881 ,2701.037075 ,1860.514216 ,1413.511626 ,1767.941375 ,2594.25294 ,3134.599813 ,2900.731764 ,2117.837576 ,1510.848938 ,1635.822959 ,2373.170825 ,3044.630786 ,3039.973097 ,2374.29048 ,1666.861518 ,1567.690567 ,2162.818124 ,2902.573593 ,3111.990596 ,2609.384856 ,1866.087573 ,1567.155214 ,1982.482098 ,2725.759396 ,3116.42294 ,2805.523044 ,2089.817556 ,1631.423814 ,1847.733892 ,2533.864126 ,3059.154407 ,2949.549817 ,2317.941217 ,1751.755831 ,1769.082547 ,2346.993028 ,2951.578843 ,3033.863586 ,2530.886875 ,1914.459278 ,1751.122341 ,2183.763179 ,2809.369968 ,3056.993866 ,2711.473012 ,2102.322966 ,1792.241008 ,2059.560739 ,2650.883286 ,3023.604723 ,2846.50265 ,2296.340044 ,1884.900371 ,1985.131327 ,2495.351722 ,2943.94259 ,2927.956906 ,2477.545957 ,2016.440027 ,1965.629106 ,2361.064641 ,2832.810109 ,2953.68286 ,2628.768992 ,2170.287827 ,2000.206862 ,2263.746529 ,2708.221628 ,2927.51667 ,2736.054874 ,2327.371969 ,2082.1845 ,2215.415836 ,2590.01712 ,2858.819693 ,2789.396019 ,2467.336831 ,2199.821672 ,2224.296694 ,2499.072513 ,2761.344328 ,2781.684581 ,2568.36587 ,2338.013298 ,2298.324474 ,2459.886212 ,2650.131385 ,2697.897288 ,2596.47242 ,2488.836071};

void FuncGen_setup(uint8_t waveform, uint8_t DutyCycle, uint16_t freq){
    static uint16_t i, j;
    if (!j){
        set_DCO(FREQ_24_MHz);
        TIMER_A1->CCR[0] = 0;   //add 1 clock cycle  @ 24MHz/ 100Hz
        TIMER_A1->CCTL[0] = TIMER_A_CCTLN_CCIE; //enable interrupt, Toggle/reset mode
        //select SMCLK | select continuous mode
        TIMER_A1->CTL = TIMER_A_CTL_SSEL__SMCLK | TIMER_A_CTL_MC__CONTINUOUS;
        ISER_SEL(TA1_0_IRQn);       //enable CCR0 timer A1 interrupt in NVIC
        TIMER_A1->CCR[0] = 0;   //add 1 clock cycle  @ 24MHz/ 100Hz
        __enable_irq();     //enable interrupt globally
        j++;
    }

    if(_freq != freq || _waveform != waveform || _DutyCycle != DutyCycle){
        if ( waveform < 4 )
            _waveform = waveform;
        if ( DutyCycle < 101)
            _DutyCycle = DutyCycle;
        if( freq < 501 )
            _freq = freq;
        switch(_waveform){
            case square_wave:
                //adjust bit based on freq
                _CCR_bit = ( 2380 * 100 / _freq );
                break;
            case sine_wave:
                //adjust bit based on freq
                _CCR_bit = ( 765 * 100 / _freq );
                //load in values of sine into an array
                for ( i = 0; i < 314 ; i++)
                   sine_bit[i] = ( 1.5 * sin( (float) i / 50 ) + 1.5 ) / 3.3 * ( 1 << 12) ;
                break;
            case sawtooth_wave:
                //adjust bit based on freq
                _CCR_bit = ( 638 * 100 / _freq );
                break;
            case heart:
                //adjust bit based on freq
                _CCR_bit = ( 500 * 100 / _freq );
                //load in values of heart into an array
                /*for ( i = 0; i < 533 ; i++){
                    double x = -1.33 + 0.005 * i;
                    //draw a heart
                    heart_bit[i] = ( sqrt( cos( x / 0.85 ) ) * cos( 200 * x ) + sqrt( abs( x ) ) + PI / 4 * pow((4-pow(x,2)),0.01) + 0.1 ) / 3.3 * ( 1 << 12);
                }*/
                break;
        }
    }
}


void TA1_0_IRQHandler(){
    static uint16_t i;
    TIMER_A1->CCTL[0] &= ~TIMER_A_CCTLN_CCIFG;
    TIMER_A1->CCR[0] += _CCR_bit ;    //add 1 clock cycle  @ 24MHz/ 100Hz
    switch(_waveform){
        case square_wave:
            // cut into 100 pieces, enable the number of pieces high depending on the Duty Cycle
            if ( i < _DutyCycle ){
                voltage_bit = 3760;        // 3760 = 3V in 12 bit at 3.3V reference
                i++;
            }
            // the rest are low
            else if ( i < 100 ){
                voltage_bit = 0;
                i++;
            }
            //repeat the counter
            else i = 0;
            break;
        case sine_wave:
            if( i < 314 )
                //unload values from sine array
                voltage_bit = sine_bit[i++];
            else i = 0;
            break;
        case sawtooth_wave:
            //increment voltage by 8.056mV
            voltage_bit += 10;
            if (voltage_bit >= 3760 )
                //reset voltage to 0 if exceeds 3V
                voltage_bit = 0;
            break;
        case heart:
            if( i < 533 )
                //unload values from heart array
                voltage_bit = heart_bit[i++];
            else i = 0;
            break;
        }
}
